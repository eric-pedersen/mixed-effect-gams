
#I: Introduction

As ecology has progressed as a quantitative discipline and the questions ecologists ask have become more complicated, the statistical techniques ecologists use have increased in their flexibility to model complex relationships. Two of the more popular and powerful techniques now in use are generalized additive models [GAMs; @Wood:2006vg] for modelling flexible regression functions, and generalized linear mixed models ["hierarchical generalized linear models" (HGLMs) or simply "hierarchical models"; @Bolker:2009cs, @gelman2013bayesian] for modelling between-group variability in regression relationships.


At first glance, GAMs and HGLMs are very different tools. GAMs are used to estimate smooth functional relationships between predictor variables and the response, assuming that the phenomena under investigation is not linear (in the GLM sense) but is a smooth function of the predictor variables. Examples of such relationships would be the vertical distribution of abundance of a population as a function of depth [@stanley_biogeographic_2016] or the swimming speed of snakes as function of temperature [@vickers_using_2017]. HGLMs, on the other hand, are used to estimate linear relationships between predictor variables and response, but impose a structure where predictors are organized into groups (often referred to as "blocks") and the relationships between predictor and response may differ between those groups. Either the slope or intercept, or both, may be subject to grouping. A typical example of HGLM use might be to include site-specific effects in a model of counts, or to model individual level heterogeneity in a study with repeated observations of multiple individuals.


Both GAMs and HGLMs can be used to fit potentially highly variable models by "pooling" parameter estimates towards one another. The connection between the two methods is quite deep and GAMs may be interpreted (and fitted) as HGLMs and vice-versa. Given this connection, the obvious extension to the standard GAM framework is to allow the smooth functional relationship between predictor and response to vary between different grouping levels, but in such a way that the different functions are in some sense pooled toward each other. We often want to know both how the functional relationship between varies between groups, and if there is a strong relationship on average across groups. We will refer to this type of model as a *hierarchical GAM*, or HGAM[^func_reg].

[^func_reg]:The HGAM models we have discussed are actually a type of *functional regression*, which is an extension of standard regression models to cases where the outcome variable $y_i$ and/or the predictor variables $x_i$ for a given outcome are functions, rather than single variables [@ramsay_functional_2005]. HGAMs as we have described them are a form of function-on-scalar regression [@ramsay_functional_2005, @reiss_fast_2010], where we are trying to estimate a smooth function that varies between grouping levels. We have deliberately focused our paper on these simplier classes of functional regression model, and chosen to use the term HGAM rather than functional regression, as we believe that this more clearly connects these models to modelling approaches already familiar to ecologists. Further, we consider the unit of analysis to still be individual observations, as compared to functional regression where the the unit of analysis is whole functions (for instance, we are interested in cases like species distribution modelling, where the presence of a given species may be predicted from a sum of several species-specific functions of different environmental variables).  However, there is an extensive literature dedicated to how to fit more complex functional regression models for any interested reader (see @ramsay_functional_2005 for a good introduction, and @scheipl_generalized_2016 for more recent work in this field). The `refund` package [@reiss_fast_2010,@scheipl_functional_2014, @scheipl_generalized_2016] uses the statistical machinery from `mgcv` to fit these models, and should be usuable by anyone familiar with standard R and `mgcv` modelling syntax.

There are many potential uses for HGAMs. For example, to estimate how the maximum size of different fish species varies along a common temperature gradient (figure  \ref{fig:fish_size}). Each species will typically have its own response function, but since the species overlap in range, they should have similar responses over at least some of the temperature gradient; figure \ref{fig:fish_size} shows all three species reach their largest maximum sizes in the center of the temperature gradient. Estimating a seperate function for each species throws away a lot of shared information and could result in highly noisy function estimates if there were only a few data points for each species. Estimating a single average relationship could result in an average function that did not predict any specific group well. In our example, using a single global temperature-size relationship would miss the three species distinct temperature optima, and that the orange species is significantly smaller at all temperatures than the other two (figure \ref{fig:fish_size}). We prefer a hierarchical model that includes a global temperature-size curve plus species-specific curves that were penalized to be close to the mean function.

```{r fish_size, echo=FALSE, message=FALSE, fig.width=6, fig.height=3, cache=TRUE, fig.cap="\\label{fig:fish_size}Hypothetical example of functional variability between different group levels. Each line indicates how the maximum possible body size for different species of fish in a community might vary as a function of average water temperature. While the orange species shows lower maximum size at all temperatures, and the red and blue species differ in what temperature they can acheive the maximum possible size, all three curves are similiarly smooth, and peak close to one another, relative to the entire range of tested temperatures.", messages=FALSE, dev=c('pdf'), out.width="\\linewidth"}
knitr::include_graphics('../figures/temp_growth_example.png')
```

The ability to fit HGAMs already exists in the popular *mgcv* package for the R statistical programming language. There are many different options available respresenting different model assumptions with corresponding trade-offs. This paper will discuss the different approaches to group-level smoothing, the options for each and why a user might choose them, and demonstrate the different approaches across a range of case studies.

This paper is divided into five sections. Part II is a brief review of how GAMs work and their relation to hierarchical models. In part III, we discuss different ways of fitting HGAMS, what assumptions each model makes about how information is shared between groups, and different ways of specifying these models in *mgcv*. In part IV, we discuss some of the computational and statistical issues involved in fitting HGAMs in *mgcv*.  Finally, in part V, we work through examples analyses using this approach, to demonstrate the modelling process and how HGAMs can be incorporated into the quantitative ecologist's toolbox.

